# 부하테스트 내리기 전 backup 

### 전체 container 목록



```bash
jin@jin:~$ docker ps
CONTAINER ID   IMAGE                                   COMMAND                  CREATED       STATUS       PORTS                                                                                    NAMES
c49bac18b4e1   blog-loadtest:latest                    "java -jar app.jar"      5 days ago    Up 5 days    0.0.0.0:9003->9003/tcp, [::]:9003->9003/tcp                                              blog-loadtest
b3d41ab49fb8   prom/prometheus:v3.8.1                  "/bin/prometheus --c…"   2 weeks ago   Up 2 weeks   0.0.0.0:9090->9090/tcp, [::]:9090->9090/tcp                                              prometheus
d965a0d56c1d   grafana/grafana:12.3.1                  "/run.sh"                2 weeks ago   Up 2 weeks   0.0.0.0:8080->3000/tcp, [::]:8080->3000/tcp                                              grafana
34ad91b9a57c   nginx:alpine                            "/docker-entrypoint.…"   3 weeks ago   Up 3 weeks   0.0.0.0:80->80/tcp, [::]:80->80/tcp, 0.0.0.0:443->443/tcp, [::]:443->443/tcp, 8080/tcp   my_nginx_server
34193e79866d   mysql:latest                            "docker-entrypoint.s…"   3 weeks ago   Up 3 weeks   33060/tcp, 0.0.0.0:3002->3306/tcp, [::]:3002->3306/tcp                                   mysql-container
a268e4e32ab5   prom/mysqld-exporter:v0.15.1            "/bin/mysqld_exporte…"   3 weeks ago   Up 3 weeks   0.0.0.0:9104->9104/tcp, [::]:9104->9104/tcp                                              mysqld-exporter
3ab3ff9e5194   nginx/nginx-prometheus-exporter:1.1.0   "/usr/bin/nginx-prom…"   3 weeks ago   Up 3 weeks   0.0.0.0:9113->9113/tcp, [::]:9113->9113/tcp                                              nginx-exporter
```



### compose 단위



```bash
jin@jin:~$ docker compose ls
NAME                  STATUS              CONFIG FILES
loadteset             running(2)          /home/jin/loadTeset/docker-compose.yml
mysql                 running(1)          /home/jin/mySQL/docker-compose.yml
mysqld-exporter       running(1)          /home/jin/mysqld-exporter/docker-compose.yml
nginx                 running(1)          /home/jin/nginx/docker-compose.yml
nginx-exporter        running(1)          /home/jin/nginx-exporter/docker-compose.yml
spring-blog-backend   running(1)          /home/jin/blog-test-server/spring-blog-backend/docker-compose.yml
```



- `loadteset             running(2)` 
  -  이것만 서비스 2개 

### 1. /home/jin/loadTeset/docker-compose.yml

#### ! 아이디, 비번 채우기

```yaml
jin@jin:~/loadTeset$ cat docker-compose.yml 
services:
  prometheus:
    image: prom/prometheus:v3.8.1
    container_name: prometheus
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1.5G
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
    ports:
      - "9090:9090"
    networks:
      - load-test-net

  grafana:
    image: grafana/grafana:12.3.1
    container_name: grafana
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
    ports:
      - "8080:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=아이디
      - GF_SECURITY_ADMIN_PASSWORD=비밀번호
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - load-test-net

networks:
  load-test-net:
    external: true

volumes:
  prometheus_data:
  grafana_data:
```



#### 1-1. 프로메테우스 yaml

```bash
jin@jin:~/loadTeset/prometheus$ pwd
/home/jin/loadTeset/prometheus
jin@jin:~/loadTeset/prometheus$ cat prometheus.yml 
global:
  scrape_interval: 15s
  scrape_timeout: 10s

scrape_configs:
  - job_name: "spring-blog-loadtest"
    metrics_path: "/api/prometheus"
    static_configs:
      - targets:
          - "blog-loadtest:9003"

  - job_name: "mysql"
    static_configs:
      - targets:
          - "mysqld-exporter:9104"

  - job_name: "nginx"
    static_configs:
      - targets:
          - "nginx-exporter:9113"
```



### 2. /home/jin/mysqld-exporter/docker-compose.yml

```yaml
jin@jin:~/mysqld-exporter$ cat docker-compose.yml 
services:
  mysqld-exporter:
    image: prom/mysqld-exporter:v0.15.1
    container_name: mysqld-exporter
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
    restart: unless-stopped
    ports:
      - "9104:9104"
    volumes:
      - ./.my.cnf:/.my.cnf:ro
    command:
      - --config.my-cnf=/.my.cnf
    networks:
      - load-test-net

networks:
  load-test-net:
    external: true
```



### 3. /home/jin/nginx-exporter/docker-compose.yml



```yaml
jin@jin:~/nginx-exporter$ cat docker-compose.yml 
services:
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:1.1.0
    container_name: nginx-exporter
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M  
    command:
      - -nginx.scrape-uri=http://my_nginx_server:8080/stub_status
    ports:
      - "9113:9113"
    networks:
      - my-network
      - load-test-net
    restart: unless-stopped

networks:
  my-network:
    external: true
  load-test-net:
    external: true
```



### nginx metrics.yml

```bash
jin@jin:~/nginx/nginx/conf.d$ cat metrics.conf 
server {
    listen 8080;
    server_name localhost;

    location /stub_status {
        stub_status;

        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
    }
}
```







